  <script type='text/javascript'>
    /*Class for dropdowns that must trigger another dropdown to be
      filled with data from an Ajax call.
      param $source: The jquery select of the <select> being the trigger.
      param next: A NuageLinkedSelect who should be updated when the $source
          is triggered ($source.change).
      param url: The ajax command used to fill the $source with data.
      param qparam: A queryparam which is added to the url.
      param pre_trigger: A function which will be executed before Ajax
          call happens. This function can return false or true to cancel or
          continue. Default null. No function parameters. Use 'this' to access
          the NuageLinkedSelect object.
      param data_to_opts: A function that receives the <select> options and the
          json data as input. It is up to the function how to turn the data into
          <option>s
      param opt_name: A function that turns the object from the Ajax call into a
          String to be used as name for the <Option>. Default is ajax-obj.name.
          One function parameter: a single Ajax object.
      param opt_val: A function that turns the object from the Ajax call into a
          String to be used as value for the <Option>. Default is ajax-obj.id.
          One function parameter: a single Ajax object.
    */
    function NuageLinkedSelect(data) {
      this.$source = data['$source'];
      this.next = data['next'];
      this.url = data['url'];
      this.qparam = data['qparam'];
      this.pre_trigger = data['pre_trigger'];
      this.data_to_opts = data['data_to_opts'];
      this.opt_name = data['opt_name'] || function(obj){
        return obj.name;
      };
      this.opt_val = data['opt_val'] || function(obj){
        return obj.id;
      };
      this.page_size = 15;
      this.page = 0;
      this.data = null;

      var self = this;
      this.$source.change(function(event) {
        if (self.next) {
          self.next.hide();
          self.next.hide_next();
        }

        var opt = self.get_opt();
        if (!opt.custom && self.pre_trigger) {
          var result = self.pre_trigger();
          if (!result)
            return;
        }

        if (!opt.custom && self.next) {
          self.next.load_data(self.$source.val());
          self.next.show();
        } else if (opt.custom_func) {
          opt.custom_func();
          event.preventDefault();
        }
      });
      this.get_opts()[0].custom = true;
    }

    NuageLinkedSelect.prototype.hide_next = function() {
      if (this.next) {
        this.next.hide();
        this.next.hide_next();
      }
    };

    NuageLinkedSelect.prototype.hide = function() {
      this.clear_opts();
      this.$source.parent().parent().hide();
    };

    NuageLinkedSelect.prototype.show = function() {
      this.$source.parent().parent().show();
    };

    NuageLinkedSelect.prototype.load_data = function(param) {
      var self = this;
      var data = {};
      if (this.qparam)
        data[this.qparam]= param;

      var img = document.createElement("img");
      img.src = "/static/dashboard/img/spinner.gif";
      this.$source.parent().before(img);

      $.ajax({
        type: 'GET',
        url: self.url,
        data: data,
        dataType: 'json',
        headers: {'X-Nuage-PageSize': 1, 'X-Nuage-Page': this.page},
        async: true,
        success: function (data) {
          self.data = data;
          self.show_page(0);
        },
        complete: function() {
          img.remove();
        }
      });
    };

    NuageLinkedSelect.prototype.show_page = function(page) {
      this.clear_opts();
      var opts = this.get_opts();
      var page_data = this.data.slice(this.page_size * page,
              this.page_size * page + this.page_size);
      if (!this.data_to_opts) {
        for (var i=0 ; i<page_data.length ; i++) {
          var obj =page_data[i];
            var opt = new Option(this.opt_name(obj), this.opt_val(obj));
            opt.obj = obj;
            opts[opts.length] = opt;
        }
      } else {
        this.data_to_opts(opts, page_data)
      }
      this.page = page;

      var select = this.$source[0];
      if (page > 0) {
        var opt = new Option('< Previous', '');
        opt.custom = true;
        var self = this;
        opt.custom_func = function() {
          self.show_page(self.page-1)
        };
        select.insertBefore(opt, select[0].nextSibling);
        select.add(opt, 1);
      }
      if (page+1 < this.data.length / this.page_size) {
        var opt = new Option('Next >', '');
        opt.custom = true;
        var self = this;
        opt.custom_func = function() {
          self.show_page(self.page+1)
        };
        select.add(opt);
      }
    };

    NuageLinkedSelect.prototype.clear_opts = function() {
      var firstOption = this.get_opts()[0];
      this.$source.empty();
      var options = this.get_opts();
      options[0] = firstOption;
    };

    NuageLinkedSelect.prototype.get_opts = function() {
      return this.$source[0].options;
    };

    NuageLinkedSelect.prototype.get_opt = function() {
      return this.$source.find('option:selected')[0]
    };

    // End of class

    function hideTab(checked, hide_on, hide_tab) {
      if (checked == hide_on) {
        // If the checkbox is not checked then hide the tab
        $('*[data-target="#' + hide_tab + '"]').parent().hide();
        $('.button-next').hide();
        $('.button-final').show();
      } else if (!$('*[data-target="#' + hide_tab + '"]').parent().is(':visible')) {
        // If the checkbox is checked and the tab is currently hidden then show the tab again
        $('*[data-target="#' + hide_tab + '"]').parent().show();
        $('.button-final').hide();
        $('.button-next').show();
      }
    }

    $(document).on("change", 'input.switchable', function (evt) {
      var $fieldset = $(evt.target).closest('fieldset'),
          $switchables = $fieldset.find('input.switchable');

      $switchables.each(function (index, switchable) {
        var $switchable = $(switchable),
          hide_tabs = $switchable.data('hide-tabs'),
          checked = $switchable.prop('checked'),
          hide_on = $switchable.data('hideOnChecked');

        if (hide_tabs) {
          hide_tabs = hide_tabs.split(' ');
          for (var i = 0; i < hide_tabs.length; i++) {
            hideTab(checked, hide_on, hide_tabs[i]);
          }
        }
      });
    });
    var wizard = $('.workflow.wizard');

    horizon.modals.init_wizard = function () {
      // If workflow is in wizard mode, initialize wizard.
      var _max_visited_step = 0;
      var _validate_steps = function (start, end) {
        var $form = $('.workflow > form'),
            response = {};

        if (typeof end === 'undefined') {
          end = start;
        }

        // Clear old errors.
        $form.find('div.row div.alert-danger').remove();
        $form.find('.form-group.error').each(function () {
          var $group = $(this);
          $group.removeClass('error');
          $group.find('span.help-block.alert-danger').remove();
        });

        // Send the data for validation.
        $.ajax({
          type: 'POST',
          url: $form.attr('action'),
          headers: {
            'X-Horizon-Validate-Step-Start': start,
            'X-Horizon-Validate-Step-End': end
          },
          data: $form.serialize(),
          dataType: 'json',
          async: false,
          success: function (data) { response = data; }
        });

        // Handle errors.
        if (response.has_errors) {
          var first_field = true;

          $.each(response.errors, function (step_slug, step_errors) {
            var step_id = response.workflow_slug + '__' + step_slug,
                $fieldset = $form.find('#' + step_id);
            $.each(step_errors, function (field, errors) {
              var $field;
              if (field === '__all__') {
                // Add global errors.
                $.each(errors, function (index, error) {
                  $fieldset.find('div.row').prepend(
                          '<div class="alert alert-danger">' +
                          error + '</div>');
                });
                $fieldset.find('input,  select, textarea').first().focus();
                return;
              }
              // Add field errors.
              $field = $fieldset.find('[name="' + field + '"]');
              $field.closest('.form-group').addClass('error');
              $.each(errors, function (index, error) {
                $field.before(
                        '<span class="help-block alert-danger">' +
                        error + '</span>');
              });
              // Focus the first invalid field.
              if (first_field) {
                $field.focus();
                first_field = false;
              }
            });
          });

          return false;
        }

        var formData = response.form_data;
        if (formData) {
          $.each(formData, function (id, value) {
            $('#' + id).val(value);
          });
        }

        var lockedFields = response.locked_fields;
        if (lockedFields) {
          $.each(lockedFields, function (id, locked) {
            var element = $('#' + id);
            if (locked) {
              element.attr('readonly', 'readonly');
              if (element.is('select')) {
                element.attr('onfocus', 'this.defaultIndex=this.selectedIndex;');
                element.attr('onchange', 'this.selectedIndex=this.defaultIndex;');
              }
            } else {
              element.removeAttr('readonly');
              if (element.is('select')) {
                element.removeAttr('onfocus', 'this.defaultIndex=this.selectedIndex;');
                element.removeAttr('onchange', 'this.selectedIndex=this.defaultIndex;');
              }
            }
          });
        }

        var hiddenFields = response.hidden_fields;
        if (hiddenFields) {
          $.each(hiddenFields, function (id, hidden) {
            if (hidden)
              $('#' + id).parent().parent().hide();
            else
              $('#' + id).parent().parent().show();
          });
        }
      };

      $('.workflow.wizard').bootstrapWizard({
        tabClass: 'wizard-tabs',
        nextSelector: '.button-next',
        previousSelector: '.button-previous',
        onTabShow: function (tab, navigation, index) {
          var $navs = navigation.find('li');
          var total = $navs.length;
          var current = index;
          var $footer = $('.modal-footer');
          _max_visited_step = Math.max(_max_visited_step, current);
          if (current + 1 >= total) {
            $footer.find('.button-next').hide();
            $footer.find('.button-final').show();
          } else {
            $footer.find('.button-next').show();
            $footer.find('.button-final').hide();
          }
          $navs.each(function(i) {
            $this = $(this);
            if (i <= _max_visited_step) {
              $this.addClass('done');
            } else {
              $this.removeClass('done');
            }
          });
        },
        onNext: function ($tab, $nav, index) {
          return _validate_steps(index - 1);
        },
        onTabClick: function ($tab, $nav, current, index) {
          // Validate if moving forward, but move backwards without validation
          return (index <= current ||
              _validate_steps(current, index - 1) !== false);
        }
      })
    };

    function L2_L3_optgroups(group, page_data, select) {
      var groupElement;
      for (var i=0 ; i<page_data.length ; i++) {
        var obj = page_data[i];
        if (obj.type == group) {
          if (!groupElement) {
            groupElement = document.createElement("OPTGROUP");
            groupElement.label=group;
            select.$source.append(groupElement);
          }
          var opt = new Option(select.opt_name(obj), select.opt_val(obj));
          opt.obj = obj;
          groupElement.appendChild(opt);
        }
      }
    }

    var subnet_select = new NuageLinkedSelect({
      $source: $('#id_sub_id'),
      url: '/project/networks/listSubnets',
      qparam: 'zone_id'
    });
    var zone_select = new NuageLinkedSelect({
      $source: $('#id_zone_id'),
      url: '/project/networks/listZones',
      qparam: 'dom_id',
      next: subnet_select
    });
    var domain_select = new NuageLinkedSelect({
      $source: $('#id_dom_id'),
      pre_trigger: function() {
        var type = this.get_opt().obj['type'];
        if (type == 'L2') {
          var l2dom_id = this.$source.val();
          subnet_select.clear_opts();
          var opts = subnet_select.get_opts();
          opts[opts.length] = new Option(l2dom_id, l2dom_id);
          subnet_select.$source.val(l2dom_id);
          return false;
        }
        return type == 'L3'
      },
      url: '/project/networks/listDomains',
      qparam: 'org_id',
      data_to_opts: function(opts, page_data) {
        L2_L3_optgroups("L2", page_data, this) ;
        L2_L3_optgroups("L3", page_data, this) ;
      },
      next: zone_select
    });
    var organisation_select = new NuageLinkedSelect({
      $source: $('#id_org_id'),
      url: '/project/networks/listOrganizations',
      next: domain_select
    });
    var subnet_type_select = new NuageLinkedSelect({
      $source: $('#id_subnet_type'),
      pre_trigger: function() {
        return this.$source.val() == 'vsd_auto';
      },
      next: organisation_select
    });

    subnet_type_select.hide_next();
  </script>
